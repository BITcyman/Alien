# 总结

这是一份对OS比赛的总结。

## Why?

为什么要开发Alien OS？这是一个很早就有的想法。从接触到OS相关的课程以后，我就对操作系统产生了很大的兴趣，并在之后的学习中将大部分精力放在了与操作系统相关的学习当中。陆陆续续也写过一些操作系统模块，比如文件系统、内存管理等，也做过os的移植工作。但总的来说，这些工作似乎都比较碎片化、不成体系，而且都在围绕已有的os进行，因此我就想，是否可以有一个自己实现的os，这样我就能完全把握os的各个部分，因为完全由自己实现，我可以对os进行任意的更改，实践一些新的想法。因为已经学习过很多os相关的东西，而且也也写过os的代码，因此从零写一个os应该是没有问题的。

## How？

乍一看似乎只要按部就班逐步实现os的几个大模块就可以写出一个完整的os，但当真正开始动手后，一切又没有想象的那么简单了。到比赛结束，os的开发主要分为3个阶段。

### 第一阶段

第一阶段其实很简单，我们只要实现要求的系统调用，基本就可以通过初赛的测试。这个阶段学校也有很多事情需要处理，时间有限，因此我们这个阶段的目标主要就是

1. 搭建基本内核结构
2. 实现基本的内存管理
3. 实现单核下的进程模型
4. 实现要求的测试程序
5. 完成文件系统

这些小目标其实已经涵盖了os中最核心的几个部分，但是这个阶段的实现我们尽量保持简单。

### 第二阶段

6月份结束学校的学习后，有了更多的时间投入到os开发中。相比往年，第二阶段比赛的要求变得更多，我们需要通过的测试更多了，而且有些测试程序对系统的实现要求还很高，因此，这个阶段我们的目标就是尽量通过所有测试，在保证实现正确的情况下优化系统实现。因为测试程序增加了一些网络相关的，而且往年没有选手做过这个部分，因此网络支持也是我们的目标之一。这个阶段主要的工作如下:

- 增加线程模型
- 增加多核支持
- 改进页表实现
- 改进内存管理
- 加入信号机制
- 加入同步互斥
- 文件系统改进
- 开发板驱动实现
- 从libc-test开始，逐个添加syscall
- 增加真实开发板支持

在第二阶段结束前，我们通过了绝大部分测试程序，对于网络相关的，虽然内核中已经添加了相关syscall实现，但是我们发现目前的实现似乎并不能完整通过测试，而且实现相当丑陋，引入了许多全局变量，因此我们暂时放弃了通过网络测试。但好在其他部分都还比较顺利，最终向qemu、startfive2、unmatched三个平台提交了评测。



### 第三阶段

事实上比赛没有第三阶段，在没有到现场比赛答辩前我们称之为第三阶段，因为在第二阶段我们暂时放弃了网络支持，到第三阶段，我们重新将网络实现提上了日程，在参考了`Arceos` 以及`virtio-net`的实现后，我们将`Arceos`中的网络模块移植到了内核当中，并根据需要修改了一部分实现，经过几次调试之后，网络部分终于可以开始工作了。参考往年选手在这一阶段做的事情，我们这一阶段的目标就是

1. 修复已有的bug
2. 性能提升
3. 增加真实linux应用的支持

通过反复运行测试，可以得到内核实现的错误信息，我们再对这些实现有误的系统调用逐一修正。

对于性能提升，主要放在了内存管理模块中，添加了LazyAllocation、COW等机制。

对于真实应用支持，我们则选择了:

1. bash
2. redis
3. sqlite3

因为一直对GUI抱有兴趣，因此我们考察了目前rust生态中可用于嵌入式系统的gui框架，最终选取了`slint`和`embedded graphics`进行支持。

到了现场比赛中，评委组给我们提供了3个任务并且要求运行在真实的开发板上。前两个任务很简单，但当时我却被一个非常简单的错误耽搁了很长时间，这直接就导致了最后一个任务没有时间下手。不过好在最后的成绩还算不错。

在进行答辩的过程中，受到了各个评委老师的究极拷问，第一次线下面对这么多os领域的大佬，也让我倍感紧张。

## ALL

虽然这是一个比赛，但对我来说比赛是次要的，我更享受开发os的过程，比赛只是督促了我在有限的时间内完成os的大部分功能。从os的各个子模块开始逐个实现，最后像搭积木一样搭建起内核，在这个过程中，可能会遇到各种各样的问题，并且当你修复完其中一个问题后，马上就会弹出另一个问题，而且调试内核并不像调试普通程序那样简单，大多数时候我们可能会需要查看各个寄存器的值，以确定当前os处于一个正确的状态，在模拟器上这个工作还不算困难，当在开发板上运行出现错误时更加难以调试，至少在我开发过程中，只能使用原始的`print`在开发板上debug。未来我想我们也应该学习在物理开发板上调试裸机程序。通过实现一个完整的os，我也再次加深了对os的理解，这为未来继续在此领域深耕应该有很大的帮助。当然了，我们实现的os还存在许多不完善的地方，虽然我们已经可以运行很多测试，可以运行真实的应用，但是我们不能保证os具有linux一样的容错度，也许一个新的测试就能轻易地击垮它，而且内核中许多部分都值得再次打磨，那些丑陋的代码需要被清理。在接下来的工作中，我也会逐步地完善Alien,在清理完那些不好的实现后，向其添加更多的功能支持。

